#!/usr/bin/env python
#-*- coding: UTF-8 -*-

import simplejson
import urllib
import urllib2
import os
from ovizart.modules.malware.virustotal import postfile

from ovizart.modules.md5.handler import Handler as MD5Handler

RESCAN_URL = "https://www.virustotal.com/vtapi/v2/file/rescan"
API_KEY = "891c2810d3931fac5af1a2861ac9db18e508a972bb1eaa03d0b43428938d4b93"
HOST = "www.virustotal.com"
SCAN_URL = "https://www.virustotal.com/vtapi/v2/file/scan"
REPORT_URL = "https://www.virustotal.com/vtapi/v2/file/report"

class Handler:

    def __init__(self):
        self.md5_handler = MD5Handler()

    def rescan(self, file_path):
        file_md5 = self.md5_handler.get_hash(file_path)
        parameters = {"resource": file_md5, "apikey": API_KEY}
        data = urllib.urlencode(parameters)
        req = urllib2.Request(RESCAN_URL, data)
        try:
            response = urllib2.urlopen(req)
            json = response.read()
            return simplejson.loads(json)
        except simplejson.JSONDecodeError:
            return False


    def scan(self, file_path):
        fields = [("apikey", API_KEY)]
        file_to_send = open(file_path, "rb").read()
        files = [("file", os.path.basename(file_path), file_to_send)]
        try:
            json = postfile.post_multipart(HOST, SCAN_URL, fields, files)
            return simplejson.loads(json)
        except simplejson.JSONDecodeError:
            return False

    def get_report(self, file_path):
        file_md5 = self.md5_handler.get_hash(file_path)
        parameters = {"resource": file_md5, "apikey": API_KEY}
        data = urllib.urlencode(parameters)
        req = urllib2.Request(REPORT_URL, data)
        try:
            response = urllib2.urlopen(req)
            json = response.read()
            return simplejson.loads(json)
        except simplejson.JSONDecodeError:
            return False
